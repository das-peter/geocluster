<?php

require_once 'geocluster.geohash.inc';

/**
 * @file
 * Geocluster extension for geofield and maps.
 */

/**
 * Implements hook_views_api().
 */
function geocluster_views_api() {
  return array(
    'api' => '3',
  );
}

/**
 * Invokes clustering after the views query has been executed.
 *
 * Implements hook_views_post_execute_query().
 */
function geocluster_views_post_execute_query(&$view) {
  if ($cluster = _geocluster_get_instance($view)) {
    $cluster->cluster($view);
  };
}

/**
 * Adds geocluster information to a leaflet data item.
 *
 * Implements hook_leaflet_views_alter_points_data().
 */
function geocluster_leaflet_views_alter_points_data($result, &$points) {
  if (isset($result->clustered)) {
    // Add cluster info to every points data entry.
    array_walk($points, function(&$point, $key, $count) {
      $point['clustered'] = TRUE;
      $point['cluster_items'] = $count;
    }, count($result->ids));
  }
}

/**
 * Adds geocluster information to a views_geojson result.
 *
 * Implements hook_views_geojson_render_fields_alter().
 */
function geocluster_views_geojson_render_fields_alter(&$feature, $view, $row, $index) {
  if (!empty($row->clustered)) {
    _geocluster_add_geojson_cluster_info($feature, count($row->ids));
  }
}

/**
 * Implements theme_preprocess_leaflet_map().
 */
function geocluster_preprocess_leaflet_map($variables) {
  drupal_add_js(
    drupal_get_path('module', 'geocluster') . '/js/geocluster.leaflet.marker.js',
    // Add our script after leaflet.drupal.js.
    array('weight' => 5)
  );

  drupal_add_js(
    drupal_get_path('module', 'geocluster') . '/js/geocluster.leaflet.js',
    // Add our script after leaflet.drupal.js.
    array('weight' => 5)
  );
}

/*** INTERNAL HELPERS ***/

/**
 * Retrieves the geocluster instance from a given view.
 *
 * @param $view view
 */
function _geocluster_get_instance(&$view) {
  if ($cluster = $view->display_handler->get_option('geocluster_instance')) {
    return $cluster;
  }
}

/**
 * Adds cluster info to a views_geojson feature.
 *
 * @param $feature
 * @param $cluster_items
 */
function _geocluster_add_geojson_cluster_info(&$feature, $cluster_items) {
  $feature['clustered'] = TRUE;
  $feature['cluster_items'] = $cluster_items;
}
